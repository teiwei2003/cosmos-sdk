# Cosmos ブロックチェーンシミュレーター

Cosmos SDKは、それぞれをファジングテストするための完全なシミュレーションフレームワークを提供します
モジュールによって定義されたメッセージ。

Cosmos SDKでは、この機能は[`SimApp`](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/simapp/app.go)によって提供されます。
[`simulation`](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/x/simulation)モジュールの実行に使用される` Baseapp`アプリケーション。
このモジュールは、すべてのシミュレーションロジックと操作を定義します
アカウント、残高などのランダムパラメータ。

## 目標

ブロックチェーンシミュレーターは、次の状況でブロックチェーンアプリケーションがどのように動作するかをテストします
ランダムなメッセージを生成して送信することで、実際の環境を実現します。
これの目的は、アクティブチェーンを停止させる可能性のある障害を検出してデバッグすることです。
シミュレーターによって実行された操作に関するログと統計を次のように提供することによって
また、障害が見つかった場合は、最新のアプリケーションステータスをエクスポートします。

それと統合テストの主な違いは、シミュレーターアプリケーションが許可することです
パラメータを渡して、シミュレートされるチェーンをカスタマイズできます。
これは、生成されたエラーを再現しようとするときに役立ちます
提供される操作(ランダムかどうか)。

## アナログコマンド

シミュレーションアプリケーションにはさまざまなコマンドがあり、各コマンドはさまざまなコマンドをテストします
障害タイプ:

-`AppImportExport`:シミュレーターは初期のアプリケーション状態をエクスポートし、次にそれをエクスポートします
  エクスポートされた[genesis.json]を入力として使用して新しいアプリケーションを作成し、チェックします
 ストレージ間の不整合。
-`AppSimulationAfterImport`:2つのシミュレーションを一緒に配置します。 1つ目は、アプリケーションステータス(_i.e_ Genesis)を2つ目に提供します。リアルタイムチェーンからのソフトウェアアップグレードまたはハードフォークをテストするために使用されます。
-`AppStateDeterminism`:すべてのノードが同じ順序で同じ値を返すかどうかを確認します。
-`BenchmarkInvariants`:すべてのモジュールを実行している不変条件のパフォーマンスを分析します(_i.e_ [benchmark](https://golang.org/pkg/testing/#hdr-Benchmarks)テストを順番に実行します)。不変チェック
  保存されたトラッカーとパッシブトラッカーの値の差。例:アカウントが保持するトークンの合計とサプライトラッカーの合計。
-`FullAppSimulation`:ユニバーサルシミュレーションモード。指定された数のブロックに対してチェーンと指定された操作を実行します。テストシミュレーションには[パニック]はありません。また、[期間]ごとに不変性チェックを実行しますが、ベンチマークは行われません。

各シミュレーションは、たとえば、一連の入力(_i.e_フラグ)を受け取る必要があります
シミュレーションブロック、シード、ブロックサイズなどを実行します。
フラグの完全なリストを確認してください[ここ](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/simapp/config.go#L32-L55)。

## エミュレータモード

さまざまな入力とコマンドに加えて、シミュレータは次の3つのモードでも実行されます。

1. 初期状態、モジュールパラメータ、シミュレーションは完全にランダムです
    パラメータは**疑似ランダムに生成されます**。
2. 初期状態とモジュールパラメータを定義する `genesis.json`ファイルをカスタマイズします。
    このモードは、テストが必要なアプリケーションの新しい(そしておそらく破壊的な)バージョンのリアルタイムネットワークエクスポートなど、既知の状態でシミュレーションを実行する場合に役立ちます。
3. `params.json`ファイルから、初期状態が疑似ランダムに生成されますが、モジュールとシミュレーションのパラメーターは手動で提供できます。
    これにより、状態空間を疑似ラ​​ンダムにシミュレートしたまま、より制御可能で決定論的なシミュレーション設定が可能になります。
    使用可能なパラメーターのリストは、[ここ](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/x/simulation/params.go#L44-L52)にリストされています。

::: ヒント
これらのモデルは相互に排他的ではありません。 たとえば、ランダムに実行できます
生成された作成状態( `1`)と手動で生成されたシミュレーションパラメータ(` 3`)。
:::

## 利用方法

これは、シミュレーションの実行方法の一般的な例です。 より具体的な例
Cosmos SDK [Makefile](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/Makefile#L251-L287)を確認してください。

```bash
 $ go test -mod=readonly github.com/cosmos/cosmos-sdk/simapp \
  -run=TestApp<simulation_command> \
  ...<flags>
  -v -timeout 24h
```

## デバッグスキル

以下は、シミュレーションが失敗した場合のいくつかの提案です。

-障害が見つかった高さでアプリケーションステータスをエクスポートします。できるよ
  `-ExportStatePath`フラグをシミュレーターに渡す。
-`-Verbose`ログを使用します。彼らはあなたにすべての行動に関するより良いヒントを与えることができます
  関与。
-シミュレーション `-Period`を減らします。これにより、不変チェックがさらに実行されます
  頻繁に。
-`-PrintAllInvariants`を使用して、失敗したすべての不変条件を一度に印刷します。
-別の `-Seed`を使用してみてください。同じエラーを再現して失敗する可能性がある場合
  シミュレーションの実行に費やす時間が少なくなります。
-`-NumBlocks`を減らします。以前の高さでのアプリケーションのステータスは何ですか
  失敗？
-`-SimulateEveryOperation`を使用して、各操作で不変条件を実行します。 _注_:これ
  シミュレーションが**大幅に**遅くなります。
-文書化されていない操作にログを追加しようとしました。を定義する必要があります
  [keeper]の[レコーダー](https://github.com/cosmos/cosmos-sdk/blob/v0.40.0/x/staking/keeper/keeper.go#L66-L69)。

## CosmosSDKベースのアプリケーションでシミュレーションを使用する

シミュレーションをCosmosSDKベースのアプリケーションに統合する方法を学びます。

-アプリケーションシミュレーションマネージャー
-[Building Module:Simulator](../building-modules/Simulator.md)
-シミュレータテスト