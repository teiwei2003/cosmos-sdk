# ゴールキーパー

`Keeper`はCosmosSDKの抽象化を指し、その役割は、さまざまなモジュールによって定義された状態のサブセットへのアクセスを管理することです。 `Keeper`はモジュール固有です。つまり、モジュールによって定義された状態のサブセットには、モジュールで定義された` keeper`によってのみアクセスできます。モジュールが別のモジュールによって定義された状態のサブセットにアクセスする必要がある場合、2番目のモジュール内の[キーパー]の参照を最初のモジュールに渡す必要があります。これは、モジュールマネージャーのインスタンス化中に `app.go`で行われます。 {まとめ}

## 読むための前提条件

-[Cosmos SDKモジュールの紹介](。/intro.md){前提条件}

## 動機

Cosmos SDKは、開発者が主にモジュールを組み合わせることにより、複雑な分散型アプリケーションを最初から簡単に構築できるようにするフレームワークです。 Cosmos SDKオープンソースモジュールエコシステムの拡張に伴い、これらのモジュールの一部には、開発者の過失または悪意による脆弱性が含まれている可能性が高くなっています。

Cosmos SDKは、[Object Capability-Based Method](../core/ocap.md)を採用して、開発者がモジュール間の不要な相互作用からアプリケーションをより適切に保護できるようにします。このメソッドのコアは[キーパー]です。 `keeper`は、文字通りモジュールストレージのゲートキーパーとして理解できます。モジュールで定義された各ストア(通常は[`IAVL`ストア](../core/store.md#iavl-store))には` storeKey`があり、制限なしでアクセスできます。モジュールの `keeper`はこの` storeKey`を保持し(そうでない場合はプライベートに保つ必要があります)、ストレージの読み取りと書き込みを行う[methods](#implementing-methods)を定義します。

オブジェクト機能メソッドの背後にある中心的な考え方は、ジョブを完了するために必要なものだけを明らかにすることです。実際には、これは、アクセス制御リストを介してモジュールのアクセス許可を処理する代わりに、モジュール `keeper`に、アクセスする必要のある他のモジュール` keeper`の特定のインスタンスへの参照が渡されることを意味します(これは[アプリケーションのコンストラクターにあります](../basics/app-anatomy.md#constructor-function))。したがって、モジュールは、他のモジュールの[キーパー]インスタンスによって公開されたメソッドを介してのみ、別のモジュールで定義された状態のサブセットと対話できます。これは、開発者が自分のモジュールと外部の開発者によって開発されたモジュールとの間の相互作用を制御するための優れた方法です。

## タイプ定義

`Keeper`は通常、モジュールフォルダにある`/keeper/keeper.go`ファイルに実装されます。慣例により、モジュール `keeper`のタイプは略して` Keeper`と呼ばれ、通常は次の構造に従います。 

```go
type Keeper struct {
 //External keepers, if any

 //Store key(s)

 //codec
}
```

たとえば、 `stake`モジュールからの` keeper`の型定義は次のとおりです。

+++ https://github.com/cosmos/cosmos-sdk/blob/3bafd8255a502e5a9cee07391cf8261538245dfd/x/staking/keeper/keeper.go#L23-L33

さまざまなパラメータを見てみましょう。

-予想される[キーパー]はモジュールの外部[キーパー]であり、モジュールの内部[キーパー]にはモジュールが必要です。外部の[キーパー]は、内部の[キーパー]のタイプ定義のインターフェースとしてリストされています。これらのインターフェイス自体は、モジュールフォルダのルートディレクトリにある[expected_keepers.go]ファイルで定義されています。この場合、インターフェースは依存関係の数を減らし、モジュール自体の保守を容易にするために使用されます。
-`storeKey`sは、モジュールによって管理される[multistore](../core/store.md)ストレージへのアクセスを許可します。それらは外部モジュールにさらされるべきではありません。
-`cdc`は、 `[] byte`との間で構造をマーシャリングおよびアンマーシャリングするための[codec](../core/encoding.md)です。 `cdc`は、要件に応じて、` codec.BinaryCodec`、 `codec.JSONCodec`、または` codec.Codec`のいずれかになります。それらがこれらのインターフェースを実装している限り、それはプロトまたはアミノコーデックである可能性があります。

もちろん、同じモジュールに対して異なるタイプの内部 `keeper`を定義することもできます(たとえば、読み取り専用の` keeper`)。 `keeper`の各タイプには、[アプリケーションコンストラクター](../basics/app-anatomy.md)から呼び出される独自のコンストラクターがあります。ここで `keeper`がインスタンス化され、開発者はモジュール` keeper`の正しいインスタンスをそれらを必要とする他のモジュールに確実に渡します。

## 実装

`Keeper`は主に、そのモジュールによって管理される保存されたgetterメソッドとsetterメソッドを公開します。妥当性チェックは[`message`](./messages-and-)クエリの` ValidateBasic() `メソッドに合格している必要があるため、これらのメソッドは可能な限り単純で、要求された値の取得または設定に厳密に制限する必要があります。 `keeper`s 'メソッドが呼び出されたときのmd#メッセージ)および[` Msg`サーバー](./msg-services.md)。

通常、* getter *メソッドには次のシグネチャがあります 

```go
func (k Keeper) Get(ctx sdk.Context, key string) returnType
```

このメソッドは、次の手順を実行します。

1. `storeKey`を使用して、` ctx`から適切なストアを取得します。 これは、 `ctx`の` KVStore(storeKey sdk.StoreKey) `メソッドによって行われます。 次に、利便性とセキュリティのために、 `prefix.Store`を使用して、必要なストレージの限られたサブセットのみにアクセスすることをお勧めします。
2.存在する場合は、保存されている `Get(key[] byte)`メソッドを使用して、場所 `[] byte(key)`に保存されている `[] byte`値を取得します。
3.コーデック `cdc`を使用して、取得した値を`[] byte`から `returnType`にアンマーシャリングします。 戻り値。

同様に、* setter *メソッドには次の署名があります 

```go
func (k Keeper) Set(ctx sdk.Context, key string, value valueType)
```

このメソッドは、次の手順を実行します。

1. `storeKey`を使用して、` ctx`から適切なストアを取得します。これは、 `ctx`の` KVStore(storeKey sdk.StoreKey) `メソッドによって行われます。利便性とセキュリティのために、必要なストレージの限られたサブセットにのみアクセスするには、 `prefix.Store`を使用するのが最適です。
2.コーデック `cdc`を使用して、` value`を `[] byte`にグループ化します。
3.ストアの `Set(key[] byte、value[] byte)`メソッドを使用して、ストアの `key`の場所にエンコード値を設定します。

詳細については、 `keeper`の例を参照してください[` stakeing`モジュールでのメソッドの実装](https://github.com/cosmos/cosmos-sdk/blob/3bafd8255a502e5a9cee07391cf8261538245dfd/x/staking/keeper/keeper.go )。

[module `KVStore`](../core/store.md#kvstore-and-commitkvstore-interfaces)は、キーフィールドを反復するために` Iterator`オブジェクトを返す `Iterator()`メソッドも提供します。

これは、アカウントを反復するための `auth`モジュールの例です。

+++ https://github.com/cosmos/cosmos-sdk/blob/bf8809ef9840b4f5369887a38d8345e2380a567f/x/auth/keeper/account.go#L70-L83

## 次へ{hide}

[invariants](./invariants.md){hide}を理解する 