# ADR 039:画期的な賭け

## 変更ログ

-2021年2月10日:最初のドラフト

## 著者

-Dev Ojha(@valardragon)
-Sunny Aggarwal(@ sunya97)

## 状態

提案

## 概要

ADRは、コンセンサスエクイティウェイトを更新する前に、エクイティプルーフモジュールを更新して、複数のブロックのエクイティプルーフウェイトの更新をバッファリングします。バッファの長さはエポックと呼ばれます。ステーキングモジュールのアプリオリ機能は抽象モジュールの特殊なケースであり、エポックは1ブロックに設定されます。

## 環境

現在のエクイティプルーフモジュールは、設計上の決定を採用し、エクイティウェイトの変更をコンセンサスエンジンに即座に適用します。これは、委任とバインド解除がバリデーターセットにすぐに適用されることを意味します。この決定は主に、実装が最も簡単であり、顧客により良いユーザーエクスペリエンスをもたらすと信じていたためです。

別の設計オプションは、複数のブロック(委任、バインド解除、検証者の結合)の誓約更新のバッファリングを許可することです。この種の[エポック]エクイティコンセンサスプルーフは、スラッシュ条件がない限り、検証者のコンセンサスウェイトが中期的に変化しないことを保証します。

さらに、ユーザーエクスペリエンスの障壁は、以前考えられていたほど重要ではない場合があります。これは、ユーザーが自分の預金が記録され、実行されることをすぐに確認できるためです。

さらに、時間の経過とともに、次のようなステーキングイベントの即時実行の制限がますます明白になっています。

*しきい値に基づく暗号化。主な制限の1つは、バリデーターセットを定期的に変更できるため、固定のバリデーターセットからマルチパーティ計算を実行することが困難になることです。ランダムビーコンやしきい値復号化など、ブロックチェーンの多くのしきい値ベースの暗号化機能には、計算コストの高いDKGプロセスが必要です(作成時間は1ブロックの作成よりもはるかに長くなります)。これらを有効に活用するためには、DKGの成果を長期にわたって活用していく必要があります。ブロックごとにDKGを再実行することはできません。エポックステーキングにより、エポックごとに1回だけ新しいDKGを実行する必要があることが保証されます。

*軽いクライアント効率。これにより、バリデーターセットに大量のチャーンがある場合のIBCのオーバーヘッドが削減されます。 Tendermint lightクライアントの二分法アルゴリズムでは、検証する必要のあるヘッダーの数は、信頼できるヘッダーと最新のヘッダーの間のバリデーターセットの差の制限に関連しています。差が大きすぎる場合は、2つの間のヘッダーをさらに確認してください。バリデーターセットへの変更の頻度を制限することにより、バリデーターセットの解約率が高い場合に発生するIBCliteクライアントアテステーションのワーストケースサイズを減らすことができます。

*リーダー選挙の公平性について決定論的。現在、エポックなしで決定論的リーダー選挙の公平性について推論する方法はありません(tendermint .spec#217)。リーダー選挙の公平性を破ることは、提案者になることで追加の報酬を得ることができるため、バリデーターにとって有益です。エポックを追加すると、少なくとも、決定論的なリーダー選挙が安全であると証明できるものと一致することが容易になります。 (それでも、現在のアルゴリズムが、エクイティの変更が存在する場合に2つを超えるバリデーターに対して公平であるかどうかはまだ証明されていません)

*ステーキングデリバティブデザイン。現在、F1料金の分配を使用して報酬の分配が遅れています。計算の複雑さを軽減する一方で、怠惰な簿記には、よりステートフルなステーキングの実装が必要です。ここで、各委任エントリは、最後の撤回の時刻を追跡する必要があります。この問題に対処することは、単一のバリデーターに誓約されたすべてのトークンに代替可能性を提供しようとする一部の誓約派生設計にとっては課題となる可能性があります。ユーザーに報酬の撤回を強制することはこの問題の解決に役立ちますが、ブロックごとにユーザーへの報酬を強制的に撤回することは現実的ではありません。エポックを使用すると、チェーンはより簡単にデザインを変更して報酬の撤回を強制でき(各エポックはプリンシパルアカウントを1回だけ繰り返す)、コミッション時間を州から削除できます。これは、特定の住宅ローンのデリバティブの設計に役立つ場合があります。 

## 設計上の考慮事項

### スラッシュ

スラッシュをすぐに適用するか、エポックの最後に適用するかについては、設計上の考慮事項があります。スラッシュイベントは、違反期間中、つまりスラッシュイベントが発生した期間中に実際に賭けたメンバーにのみ適用する必要があります。

すぐに適用すると、より高いコンセンサスレイヤーのセキュリティが提供されると見なすことができますが、上記のユースケースには潜在的なコストがかかります。コンセンサスレイヤーのセキュリティを即座に削減するメリットは、バリデーター刑務所をすぐに実行し(したがって、バリデーターセットから削除し)、検証権の変更の実際の削減をエポック境界まで遅らせることで得られます。上記のユースケースでは、以下に示すように、問題を回避するために回避策を統合できます。

-しきい値ベースの暗号化の場合、この設定により、しきい値暗号化で元の時代の重みを使用できるようになり、コンセンサスを更新して、追加のセキュリティをより迅速に活用できるようにする必要があります。しきい値ベースの暗号化によってチェーンの活性が妨げられる場合は、残りのバリデーターの活性しきい値を効果的に引き上げています。 (あるいは、投獄されたノードは引き続きシェアを提供できます)極端な場合、計画は失敗します。つまり、バリデーターの3分の1以上が単一のエポック内に投獄されます。この極端なケースでは、チェーンにはすでに独自のカスタムインシデント対応計画があり、しきい値パスワードの処理方法を定義することもその一部である必要があります。
-ライトクライアントの効率を高めるために、ヘッダーには、ピリオド内のスラッシュを示すポイントを含めることができます(ala https://github.com/tendermint/spec/issues/199)。
-リーダー選挙の公平性を判断するために、エポック内でスラッシュまたは投獄を適用すると、私たちが提供しようとしている保証が損なわれます。次に、これにより、公平性の保証を提供するための新しい(ただし明らかに単純な)問題が再導入されます。言い換えれば、検証者は、敵対的に提案者のセットから自分自身を削除することを選択できます。セキュリティの観点から、これは2つの異なるメカニズムを介して処理される可能性があります(または、達成するのが依然として困難であることが判明する可能性があります)。 1つは、セキュリティステートメントを作成し、攻撃者がユーザーに事前に固定しきい値を設定して、一定期間内に設定された提案者から撤退するように強制する能力があることを認めることです。 2番目の方法はパラメーター化です。これは提案者であるため、エポックでのスラッシュのコストはメリットをはるかに上回ります。ただし、後者の基準は非常に疑わしいものです。複雑なステートマシンを備えたチェーンでは、提案者になることで多くの有益な副作用が発生する可能性があるためです。 (つまり、Fomo3DなどのDeFiゲーム)
-問題を引き起こさないステーキングの派生設計。バリデーターアドレスが与えられると、スラッシュが発生するかどうかは完全に照会可能であるため、これによってステーキングレコードの状態サイズが大きくなることはありません。
### トークンのロックアップ

誰かが委託取引を行う場合、すぐに誓約されていなくても、トークンは誓約モジュールによって管理されるプールに転送され、期間の終わりに使用される必要があります。これにより、トークンがどこにステーキングされているかを心配し、それらがステーキングに割り当てられていることに気付かずにこれらのトークンを使用して、ステーキングトランザクションが失敗するのを防ぐことができます。

### エポックのパイプライン化

特にしきい値ベースの暗号化では、エポック変更のためのパイプラインが必要です。これは、エポックNにいるときに、バリデーターセットがそれに応じてDKGを実行できるように、エポックN +1の重みを固定する必要があるためです。したがって、現在N番目の期間にいる場合は、N + 1番目の期間のエクイティウェイトを固定し、新しいエクイティの変更をN +2番目の期間に適用する必要があります。

これは、エポックパイプの長さのパラメータを設定することで処理できます。ハードフォーク中を除いて、パイプラインの長さの切り替えの複雑さを軽減するために、このパラメーターを変更しないでください。

パイプの長さが1の場合、エポックNの間に再割り当てすると、エポックN +1の開始前に再割り当てが適用されます。
パイプラインの長さが2の場合、N番目の期間に再割り当てすると、N +2番目の期間が開始する前に再委任が適用されます。

### 賞

すべてのステーキングの更新がエポック境界に適用された場合でも、報酬が請求されるとすぐに配布できます。これは、報酬の自動バインドを実現していないため、現在のエクイティウェイトに影響を与えないためです。このような関数を実装する場合は、報酬がエポック境界に自動的にバインドされるように設定する必要があります。

### パラメータ化されたエポック長

エポックの長さを選択するときは、キューイングステータス/計算構造を比較検討し、前述の即時実行制限を相殺する必要があります(特定のチェーンに適用される場合)。

可変ブロック時間ABCIメカニズムが導入される前は、計算の累積のために高い期間長を使用することは賢明ではありませんでした。これは、ブロックの実行時間がTendermintの予想ブロック時間よりも長い場合、ラウンドが増加する可能性があるためです。

## 決定

__Step-1__:すべての誓約とカットメッセージのバッファーを実現します。

まず、バインドされているトークンを格納するためのプールを作成しますが、これは[EpochDelegationPool]と呼ばれるエポック境界で適用する必要があります。次に、2つの別々のキューがあります。1つはステーキング用で、もう1つはスラッシュ用です。各メッセージが配信されたときに何が起こるかを以下に説明します。

###誓約ニュース

-** MsgCreateValidator **:ユーザーのセルフバインディングをすぐに `EpochDelegationPool`に移動します。 [EpochDelegationPool]から資金を取得して、自己拘束を処理するためのエポック境界のメッセージをキューに入れます。エポックの実行が失敗した場合、資金はエポックデレゲーションプールからユーザーのアカウントに返還されます。
-** MsgEditValidator **:メッセージを検証します。有効な場合は、エポックの最後に実行するためにメッセージをキューに入れます。
-** MsgDelegate **:ユーザーの資金をすぐに `EpochDelegationPool`に送金します。委任を処理するためのエポック境界のメッセージをキューに入れ、[EpochDelegationPool]から資金を取得します。エポックの実行が失敗した場合、資金はエポックデレゲーションプールからユーザーのアカウントに返還されます。
-** MsgBeginRedelegate **:メッセージを確認します。有効な場合は、エポックの最後に実行するためにメッセージをキューに入れます。
-** MsgUndelegate **:メッセージを確認します。有効な場合は、エポックの最後に実行するためにメッセージをキューに入れます。 

### メッセージをカット

-** MsgUnjail **:メッセージを確認します。有効な場合は、エポックの最後に実行するためにメッセージをキューに入れます。
-**スラッシュイベント**:スラッシュイベントが作成されるたびに、エポックの最後に適用されるスラッシュモジュールのキューに入れられます。このスラッシュがすぐに適用されるように、キューを設定する必要があります。

### 証拠メッセージ

-** MsgSubmitEvidence **:すぐに実行すると、バリデーターはすぐに投獄されます。ただし、スラッシュでは、実際のスラッシュイベントがキューに入れられます。

次に、エンドブロッカーにメソッドを追加して、キューがエポック境界でクリアされ、委任された更新が適用されるようにします。

__Step-2__:キューに入れられた誓約トランザクションのクエリを実現します。

特定のアドレスの誓約アクティビティを照会する場合、ステータスは、誓約されたトークンの数を返すだけでなく、そのアドレスでキューに入れられた誓約イベントがあるかどうかも返す必要があります。これには、キューに入れられる今後のステーキングイベントを追跡するために、クエリロジックでより多くの作業が必要になります。

最初の実装として、これは、キューに入れられたすべての住宅ローンイベントの線形検索として実装できます。ただし、長いエポックを必要とするチェーンの場合、一定時間で結果を生成できるように、最終的にはクエリをサポートするノードの追加サポートを構築する必要があります。 (これは、アドレスごとに今後のステーキングイベントにインデックスを付けるための補助ハッシュグラフを維持することで実現できます)

__ステップ-3__:ガスを調整します

現在、ガスは、トランザクションがすぐに完了したときにトランザクションを実行するためのコストを表します。 (p2pコスト、状態アクセスコスト、および計算コストのコストを組み合わせます)ただし、現在、トランザクションは、将来のブロック、つまりエポック境界で計算を引き起こす可能性があります。

この問題を解決するには、最初に将来の計算量(ガスでの価格設定)を見積もるためのパラメーターを含め、メッセージの固定料金として追加する必要があります。
ガス価格の将来の計算と現在の計算の重み付け方法の範囲から除外し、現在の重みと等しくなるように設定します。

## 結果

### ポジティブ

*既存の機能の保持を可能にするプルーフオブステークモジュールを抽象化しました
*バリデーターセットに基づくしきい値暗号化などの新機能を有効にする

### ネガティブ

*将来の実行コストも考慮する必要があるため、より複雑なガス価格設定メカニズムの統合の複雑さが増しました。
*エポック> 1の場合、ベリファイアはネットワークをすぐに離れることができなくなり、エポック境界まで待機する必要があります。 