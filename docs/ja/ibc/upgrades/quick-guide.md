# IBCチェーンとそのクライアントをアップグレードする方法

チェーンとカウンターパーティの顧客をアップグレードする方法を学びます。 {まとめ}

このドキュメントのアップグレードチェーンに関する情報は、CosmosSDKチェーンに関連しています。 ただし、カウンターパーティのお客様向けのガイドラインは、アップグレードをサポートするすべてのTendermintクライアントに関連しています。

### IBCクライアントがアップグレードを中断しました

IBC接続チェーンのアップグレードによってカウンターパーティのIBCクライアントが中断される場合は、IBCアップグレードを実行する必要があります。現在のIBCプロトコルは、IBCクライアント中断アップグレードの特定のサブセットに対するTendermintチェーンのアップグレードをサポートしています。以下は、IBCクライアントの破壊的なアップグレードの完全なリストであり、IBCプロトコルが現在そのようなアップグレードをサポートしているかどうかを示しています。

IBCは現在、計画外のアップグレードをサポートしていません。以下のすべてのアップグレードは、カウンターパーティの顧客が安全に接続を維持できるように、アップグレードチェーンによって事前に計画および約束されている必要があります。

注:アップグレードはTendermintクライアントに対してのみ実装されるため、このドキュメントでは、カウンターパーティのIBCTendermintクライアントを破棄するTendermintチェーンのアップグレードについてのみ説明します。

1.チェーンIDを変更します:**サポート**
2. UnbondingPeriodを変更します:**部分的なサポート**、チェーンは結合解除時間を増やす可能性があり、問題はありません。ただし、拘束力のない期間を短縮すると、一部の取引相手の顧客に取り返しのつかない損害を与える可能性があります。したがって、チェーンのバインド解除期間を短縮するために**お勧めしません**。
3.高さを変更します(0にリセット):チェーンがチェーンIDにリビジョン番号を追加することを覚えている限り、**サポート**。
4. ProofSpecsの変更:**サポート**。アップグレードプロセス中にIBC認定を検証するために必要な証明構造が変更された場合は、この項目を変更する必要があります。例:IAVLストレージからSimpleTreeストレージに切り替えます
5.アップグレードパスを変更します:**サポート**。これには、アップグレードクライアントとコンセンサス状態をアップグレードストレージに保存するためのキーの変更、またはアップグレードストレージ自体の移行が含まれる場合があります。
6. IBCストレージの移行:IBCストレージの場所は接続によってネゴシエートされるため、**サポートされていません**。
7.下位互換性のあるIBCバージョンへのアップグレード:サポート
8.下位互換性のないIBCバージョンにアップグレードします。接続ハンドシェイク中にIBCバージョンがネゴシエートされるため、**サポートされていません**。
9. Tendermint LightClientアルゴリズムを変更します:**部分的なサポート**。カウンターパーティも新しいライトクライアントアルゴリズムをサポートするようにアップグレードされている場合、ClientStateまたはConsensusState構造を変更しないライトクライアントアルゴリズムの変更をサポートできます。古いClientState構造を新しいClientState構造に変換するパスを提供することにより、理論的にはClientStateおよびConsensusState構造自体の更新を必要とする変更を行うことができますが、まだ実装されていません。

### CosmosSDKチェーンの段階的なアップグレードプロセス

IBCに接続されているチェーンが、カウンターパーティクライアントを混乱させるアップグレードを受けている場合は、IBCが最初に上記のリストを使用してアップグレードをサポートしていることを確認してから、カウンターパーティクライアントが損傷しないように、以下に説明するアップグレードプロセスを実行する必要があります。

1. `UpgradeProposal`を作成し、` UpgradedClientState`フィールドにIBCClientStateを含め、 `Plan`フィールドに` UpgradePlan`を作成します。 提案 `Plan`はアップグレードの高さを**のみ**(アップグレード時間なし)指定する必要があり、` ClientState`にはすべての有効なクライアントに共通のフィールドのみを含め、クライアントがカスタマイズ可能なフィールド(たとえば、TrustingPeriod)をクリアする必要があることに注意してください。 )。
2. `UpgradeProposal`に投票する

[UpgradeProposal]が渡された後、アップグレードモジュールは[upgrade/UpgradedIBCState/{upgradeHeight}/upgradedClient]というキーでUpgradedClientを送信します。 アップグレードの高さの前のブロックで、アップグレードモジュールは次のチェーンの初期コンセンサス状態も送信します。キーは `upgrade/UpgradedIBCState/{upgradeHeight}/upgradedConsState`です。

チェーンがアップグレードの高さに達して停止すると、リピーターはカウンターパーティクライアントを古いチェーンの最後のブロックにアップグレードできます。 次に、最後のブロックの[UpgradedClient]と[UpgradedConsensusState]の証明を送信して、カウンターパーティクライアントをアップグレードできます。

### リピーターアップグレードカウンターパーティのステップバイステップのアップグレードプロセス

アップグレードチェーンがアップグレードを約束すると、リレーは、チェーンがアップグレードの高さで停止するまで待ってから、対戦相手のクライアントをアップグレードする必要があります。これは、チェーンストレージが、アップグレードプランが発生する前に、アップグレードプランを再スケジュールまたはキャンセルする可能性があるためです。したがって、リレーは、チェーンがアップグレードの高さに達して停止するまで待機してから、アップグレードが確実に行われるようにする必要があります。

したがって、カウンターパーティクライアント端末をアップグレードしようとするリピータのアップグレードプロセスは次のとおりです。

1. アップグレードチェーンがアップグレードの高さに達するのを待ち、停止します
2. 古いチェーンの最後の高さで `UpgradedClient`と` UpgradedConsensusState`の証明の完全なノードを照会します。
3. `UpdateClient` msgを使用して、カウンターパーティクライアントを古いチェーンの最後の高さに更新します。
4. [UpgradeClient]、[UpgradedConsensusState]、およびそれぞれの証明書を含む[UpgradeClient]メッセージをカウンターパーティチェーンに送信します。
5. 新しくアップグレードされたチェーンのヘッダーを含む `UpdateClient`メッセージをカウンターパーティチェーンに送信します。

カウンターパーティチェーンのTendermintクライアントは、アップグレードチェーンが実際にアップグレードされたクライアントに送信されていること、およびアップグレードされたコンセンサスステータス(アップグレードの高さがキーに含まれているため)をアップグレードの高さで確認します。証明書がアップグレードの高さに従って検証された場合、クライアントは、クライアント定義のすべてのフィールドを保持したまま、新しいクライアントにアップグレードされます。したがって、古いTrustingPeriod、TrustLevel、MaxClockDriftなどを保持します。同時に、UnbondingPeriod、ChainId、UpgradePathなどの新しいチェーン指定フィールドを採用します。新しいチェーン選択フィールドを指定すると、古いクライアント選択フィールドが無効になる可能性があるため、これによりクライアントが無効になる可能性があることに注意してください。アップグレードチェーンは、古いクライアントを壊す可能性のあるパラメータを変更しないことにより、これらの状況を回避しようとする必要があります。例については、サポートされているアップグレードセクションのUnbondingPeriodの例を参照してください。

アップグレードされたコンセンサス状態は、純粋に将来の[UpdateClientMsgs]の信頼基盤として機能し、証明の検証を実行するために使用されるコンセンサスルートは含まれません。したがって、中継者は、接続を再度証明検証に使用できるように、新しいチェーンからのヘッダーを含む[UpdateClientMsg]を送信する必要があります。