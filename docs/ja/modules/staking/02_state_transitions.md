# 状態遷移

このドキュメントでは、以下に関連する状態遷移操作について説明します。

1. [バリデーター](./02_state_transitions.md#validators)
2. [委任](./02_state_transitions.md#delegations)
3. [スラッシュ](./02_state_transitions.md#slashing)

## バリデーター

バリデーターの状態遷移は、[`EndBlock`](./05_end_block.md#validator-set-changes)ごとに実行されます。
アクティブな`ValidatorSet`の変更を確認するため。

バリデーターは、`Unbonded`、`Unbonding`、または`Bonded`にすることができます。[非接着]と`Unbonding`はまとめて`NotBonded`と呼ばれます。バリデーターは、`Bonded`から`Unbonded`を除いて、すべての状態間を直接移動できます。

### 結合されていない結合

次の遷移は、`ValidatorPowerIndex`でのバリデーターのランキングが`LastValidator`のランキングを超えると発生します。

-`validator.Status`を`Bonded`に設定します
-`validator.Tokens`を`NotBondedTokens`から`BondedPool``ModuleAccount`に送信します
-`ValidatorByPowerIndex`から既存のレコードを削除します
- 新しい更新されたレコードを`ValidatorByPowerIndex`に追加します
- このバリデーターの`Validator`オブジェクトを更新します
- 存在する場合は、このバリデーターの`ValidatorQueue`レコードを削除します

### 結合と非結合

当验证者开始解除绑定过程时，会发生以下操作:

- 将`validator.Tokens`从`BondedPool`发送到`NotBondedTokens``ModuleAccount`
- 将`validator.Status`设置为`Unbonding`
- 从`ValidatorByPowerIndex`中删除现有记录
- 向`ValidatorByPowerIndex`添加一条新的更新记录
- 更新此验证器的`Validator`对象
- 为这个验证器在`ValidatorQueue`中插入一条新记录

### 未結合から非結合へ

`ValidatorQueue`オブジェクトが結合から非結合に移動すると、バリデーターは非結合から非結合に移動します

- このバリデーターの`Validator`オブジェクトを更新します
-`validator.Status`を`Unbonded`に設定します

### Jail/Unjail

バリデーターが投獄されると、テンダーミントセットから効果的に削除されます。
このプロセスは逆にすることもできます。 次の操作が発生します。

-`Validator.Jailed`を設定し、オブジェクトを更新します
- 投獄された場合、`ValidatorByPowerIndex`からレコードを削除します
- ジェイルされていない場合は、`ValidatorByPowerIndex`にレコードを追加します

投獄されたバリデーターは、次のストレージのいずれにも存在しません。

- パワーストア(コンセンサスパワーからアドレスまで)

## Delegations

### 委任

委任が発生すると、バリデーターと委任オブジェクトの両方が影響を受けます

- 委任されたトークンとバリデーターの為替レートに基づいて、委任者のシェアを決定します
- 送信アカウントからトークンを削除します
- addは委任オブジェクトを共有するか、作成されたバリデーターオブジェクトに追加します
- 新しい委任共有を追加し、`Validator`オブジェクトを更新します
-`validator.Status`が`Bonded`であるかどうかに応じて、`delegation.Amount`を委任者のアカウントから`BondedPool`または`NotBondedPool``ModuleAccount`に転送します
-`ValidatorByPowerIndex`から既存のレコードを削除します
- 新しい更新されたレコードを`ValidatorByPowerIndex`に追加します

### 接着解除を開始します

UndelegateおよびCompleteUnbonding状態遷移の一部として、UnbondDelegationが呼び出される場合があります。

- 委任者から非結合株を差し引く
- バリデーターが`Unbonding`または`Bonded`の場合、トークンを`UnbondingDelegation`エントリに追加します
- バリデーターが`Unbonded`の場合、トークンを直接引き出しに送信します
   アカウント
- 委任を更新するか、共有がなくなった場合は委任を削除します
- 委任がバリデーターのオペレーターであり、それ以上共有が存在しない場合は、jailバリデーターをトリガーします
- 委任者の共有と関連するコインを削除してバリデーターを更新します
- バリデーターの状態が`Bonded`の場合、非結合の`Coins`相当を転送します
  `BondedPool`から`NotBondedPool``ModuleAccount`への共有
- バリデーターが結合されておらず、委任シェアがなくなった場合は、バリデーターを削除します。

### 完全な剥離

すぐに完了しない委任の場合、結合解除委任キュー要素が成熟すると、次の操作が発生します。

-`UnbondingDelegation`オブジェクトからエントリを削除します
- トークンを`NotBondedPool``ModuleAccount`から委任者`Account`に転送します

### 再委任を開始する

再委任は、委任、送信元、および宛先のバリデーターに影響します。

- ソースバリデーターから[unbond]委任を実行して、結合されていない共有のトークンに相当するトークンを取得します
- 結合されていないトークンを使用して、それらを宛先バリデーターに[委任]します
-`sourceValidator.Status`が`Bonded`であり、`destinationValidator`がそうでない場合
   新しく委任されたトークンを`BondedPool`から`NotBondedPool``ModuleAccount`に転送します
- それ以外の場合、`sourceValidator.Status`が`Bonded`でなく、`destinationValidator`
   が`Bonded`の場合、新しく委任されたトークンを`NotBondedPool`から`BondedPool``ModuleAccount`に転送します
- 関連する`再委任`の新しいエントリにトークンの金額を記録します

再委任が開始されてから完了するまで、委任者は[疑似非結合]の状態にあり、再委任が開始される前に発生した違反については引き続き削減できます。。

### 完全な再委任

再委任が完了すると、次のことが発生します。

-`Redelegation`オブジェクトからエントリを削除します

## スラッシュ

### スラッシュバリデーター

バリデーターがスラッシュされると、以下が発生します。

- 合計`slashAmount`は`slashFactor`(チェーンパラメータ)として計算されます\ *`TokensFromConsensusPower`、違反時にバリデーターに結合されたトークンの総数。
- すべての非結合委任および疑似非結合再委任。これにより、非結合または非結合の前に違反が発生します。バリデーターから開始された再委任は、initialBalanceの`slashFactor`パーセンテージによってスラッシュされます。
- 再委任および非結合の委任から削減された各金額は、総スラッシュ量。
- 次に、`remaingSlashAmount`は`BondedPool`またはバリデーターのステータスに応じて`NonBondedPool`。 これにより、トークンの総供給量が減少します。

提出する証拠を必要とする違反によるスラッシュの場合(たとえば、二重署名)、スラッシュ
違反が発生したブロックではなく、証拠が含まれているブロックで発生します。
言い換えると、バリデーターは、キャッチされた場合にのみ、遡及的にスラッシュされません。

### 接着解除の委任をスラッシュ

バリデーターがスラッシュされると、結合解除を開始したバリデーターからの結合解除された代表団もスラッシュされます。
違反の時の後。 バリデーターからのすべての非結合委任のすべてのエントリ`slashFactor`によってスラッシュされます。 スラッシュ量は、の[InitialBalance]から計算されます。
委任とは、結果として生じるマイナスのバランスを防ぐために制限されています。 完了した(または成熟した)結合解除はスラッシュされません。。

### スラッシュの再委任

バリデーターがスラッシュされると、違反後に開始されたバリデーターからのすべての再委任もスラッシュされます。 再委任は`slashFactor`によってスラッシュされます。
違反の前に開始された再委任はスラッシュされません。
削減された金額は、委任の[InitialBalance]から計算され、結果として生じるマイナスのバランスを防ぐために制限されます。
(疑似アンボンディングを完了した)成熟した再委任はスラッシュされません。

## 株式の計算方法

任意の時点で、各バリデーターにはいくつかのトークン`T`があり、発行された株式の数`S`があります。
各委任者`i`は、多数の共有`S_i`を保持します。
トークンの数は、バリデーターに委任されたすべてのトークンの合計に、報酬からスラッシュを差し引いたものです。

委任者は、共有の割合に比例する基になるトークンの一部を受け取る権利があります。
したがって、委任者`i`は、バリデーターのトークンの`T * S_i/S`を受け取る権利があります。

委任者が新しいトークンをバリデーターに委任すると、その貢献に比例した数のシェアを受け取ります。
したがって、委任者`j`が`T_j`トークンを委任すると、それらは`S_j = S * T_j/T`共有を受け取ります。
トークンの総数は`T + T_j`になり、共有の総数は`S + S_j`になります。
`j`のシェアの割合は、貢献したトークンの合計の割合と同じです:`(S + S_j)/S =(T + T_j)/T`。

特殊なケースは、`T = 0`および`S = 0`の場合の最初の委任であるため、`T_j/T`は未定義です。
最初の委任では、`T_j`トークンを委任する委任者`j`は`S_j = T_j`共有を受け取ります。
したがって、報酬を受け取っておらず、スラッシュもされていないバリデーターは、`T = S`になります。 